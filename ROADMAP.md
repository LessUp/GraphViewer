# GraphViewer 开发路线图

> 本文档描述 GraphViewer 的中短期开发规划，帮助后续有节奏地推进功能、体验和工程化建设。

## 1. 项目愿景与定位

- **愿景**：做一个「开箱即用、轻量但不简陋」的一站式图形语法可视化工具，支持 Mermaid / PlantUML / Graphviz 等主流语法，适合个人及小团队日常文档和架构设计。
- **特点**：
  - 本地 + 远程混合渲染，兼顾性能与安全。
  - 支持容器化部署和一键脚本。
  - 有基础测试与基准能力，可逐步演进为更成熟的产品或开源项目。

## 2. 目标用户与典型场景

- **个人开发者 / 技术写作者**：写技术博客、文档、架构图等，需要本地预览+导出。
- **团队内部文档维护者**：在 Wiki / Confluence / Notion 等平台嵌入生成的 SVG/PNG/PDF。
- **未来可能的开源用户**：希望用一个简单好部署的图形语法工具，而不是重型平台。

根据目前状态，优先把“编辑器与预览体验”打磨好，再逐步补齐工程化和高级功能。

## 3. 阶段规划概览

- **阶段 1：编辑器与预览体验升级（优先级最高，0–2 周）**  
  提升日常使用的手感，让它从 "demo" 变成愿意天天用的工具。
- **阶段 2：稳定性与工程化打磨（2–4 周）**  
  完善测试、lint、CI 等，让改动更安心。
- **阶段 3：高级功能与生产化准备（4–8 周）**  
  多图/项目、模板库、分享体验、导入导出等功能扩展。
- **阶段 4：运维与安全治理（中长期）**  
  面向公网或大规模使用时的监控、安全和运维能力。

下面对每个阶段展开说明。

---

## 4. 阶段 1：编辑器与预览体验升级（0–2 周）

**阶段目标**：在保持现有功能的前提下，让“写图 + 看图”的体验明显变好，做到自己/团队日常用起来顺手。

### 4.1 编辑器（核心）

- **用专业代码编辑器替换 textarea**
  - 引入 CodeMirror 或 Monaco（根据个人熟悉度选择其一）。
  - 提供基本能力：行号、高亮、自动缩进、括号匹配、搜索等。
  - 按引擎切换语法高亮（Mermaid / PlantUML / Graphviz / Flowchart）。

- **快捷键与编辑辅助**
  - `Ctrl+Enter`：触发渲染预览。
  - `Ctrl+S`：触发本地保存 / 导出（至少给出提示）。
  - 可选：Tab/Shift+Tab 缩进、注释/取消注释等。

### 4.2 预览区体验

- **缩放与视图控制**
  - 支持 SVG 预览区域的缩放（Zoom in/out）和“适配屏幕（Fit to screen）”。
  - 支持拖拽平移，大图时能方便浏览。

- **实时预览模式（可配置）**
  - 增加一个“实时预览”开关：
    - 关闭时保持现在的“点击渲染”模式。
    - 打开时，对输入做防抖（如 500–1000ms）后自动渲染。

### 4.3 分享与状态

- **分享链接体验改进（基础版）**
  - 仍然使用 URL Query，但对 `code` 做压缩：
    - 采用 LZ 压缩 + Base64，将原始代码压缩之后再写入参数（如 `c=`）。
  - 在 README 和 docs 中增加：分享链接长度与限制说明。

> 阶段 1 完成后：
> - 你自己日常写图不会再受文本域限制，预览也更好用。
> - 分享链接在绝大多数场景不会因为太长而出问题。

---

## 5. 阶段 2：稳定性与工程化打磨（2–4 周）

**阶段目标**：让改动更可控，降低“改一行出一堆坑”的风险。

### 5.1 测试体系

- **单元测试**
  - 选型：Vitest 或 Jest（二选一）。
  - 优先覆盖：
    - `lib/diagramConfig.ts`：引擎/格式校验、本地渲染支持判断、Kroki 类型映射等。
    - `app/api/render/route.ts`：
      - 正常渲染（svg/png/pdf）。
      - 超长代码被拒绝。
      - Kroki 错误 / 超时场景。

- **端到端/冒烟**
  - 在已有 `scripts/smoke-test.js` 基础上：
    - 接入 CI 时自动跑一次冒烟（对部署实例）。

### 5.2 代码质量与规范

- 引入 ESLint（Next.js 官方推荐规则）+ Prettier：
  - 新增脚本：`npm run lint`、`npm run lint:fix`。
  - 在 CI 中强制通过 lint。

### 5.3 部署与脚本完善

- 修正 `scripts/deploy.sh` 在 `ENV=test` 下健康检查端口与 `docker-compose.yml` 的映射不一致的问题。
- Dockerfile 小优化：
  - 使用 `COPY package*.json ./` 保证 lockfile 一致。
  - 视情况开启 `npm ci` 代替 `npm install`（依赖锁定后）。

> 阶段 2 完成后：
> - 基础测试和规范齐备，未来重构/加功能心里更有底。

---

## 6. 阶段 3：高级功能与生产化准备（4–8 周）

**阶段目标**：把工具从“单一页面 + 单图”升级为“可以管理多个图、快速复用的日常平台”。

### 6.1 多图 / 项目管理

- 设计“多 Tab”或“图列表”能力：
  - 每个图包含：名称、引擎、最近修改时间等元信息。
  - 数据存放在 `localStorage` 或 IndexedDB。

### 6.2 模板库

- 在现有 `lib/diagramSamples.ts` 基础上扩展：
  - 加入常见业务流程、系统架构、时序图、状态机等模板。
  - 新增 UI：
    - “从模板新建”按钮。
    - 模板预览/分类（基础版可直接用下拉+描述）。

### 6.3 导入 / 导出

- 导入：
  - 支持从本地文件导入 `.mmd` / `.puml` / `.dot` 等文本文件。
- 导出：
  - 一键导出当前图的源代码文件。

### 6.4 分享与协作的后续演进（可选）

- 设计 `/api/share` 接口，支持将 code 存为短 ID：
  - 分享 URL 中只包含 ID。
  - 后端按 ID 读取并还原 code。

> 阶段 3 完成后：
> - GraphViewer 更像一个“小型图形工作台”，方便持续积累图形资产。

---

## 7. 阶段 4：运维与安全治理（中长期）

**阶段目标**：当服务要对外开放或对稳定性/安全有更高要求时，提供可演进的路径。

### 7.1 CI / CD 与部署流水线

- 使用 GitHub Actions / GitLab CI：
  - 步骤：`npm ci` → `npm run lint` → `npm run test` → 部署到测试环境 → `npm run test:smoke`。
- 与现有 `scripts/deploy.sh` 结合，形成“一键测试部署”。

### 7.2 监控与日志

- 错误追踪：接入 Sentry 或类似工具，捕获前后端异常。
- 结构化日志：在 /api 渲染日志中输出 JSON，便于后续对接 ELK / Loki 等系统。

### 7.3 安全增强

- SVG 安全：
  - 提供可选的 SVG 清洗步骤（白名单标签/属性）。
  - README 中明确不同安全级别的适用场景（内部使用 vs 公网）。
- 接入层防护：
  - 在反向代理层做限流 / IP 访问控制。
  - 可选：简单的 Token 鉴权。

---

## 8. 使用本路线图的建议

- 每次迭代前，从本文件和 `TODO.md` 中选出一小批任务，控制范围在 1–2 周内可以完成。
- 开发中如果路线有调整，可以直接在本文件标注日期和变更原因，保持一个简单的“架构演进记录”。
