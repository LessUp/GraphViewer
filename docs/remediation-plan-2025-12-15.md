# GraphViewer 整改修复计划（2025-12-15）

## 0. 背景
当前代码已完成一次以“组件拆分 + Hook 抽取 + `/api/render` 工程化”为核心的重构（参考：`docs/refactor-plan-2025-11-18.md`）。

近期梳理发现：部分功能在 UI/设置层面已经暴露，但链路未闭环或存在实现不一致，导致用户体验与架构契约不一致（例如“自定义渲染服务器”设置不生效）。

本计划的目标是：在 **不破坏既有行为** 的前提下，按优先级逐项修复这些不一致点，并补齐必要的安全约束与验收步骤。

## 1. 整改原则
- **KISS**：尽量用现有分层（`components/` + `hooks/` + `lib/` + `app/api/`）完成修复。
- **渐进式**：每个阶段可独立合并、可回滚。
- **行为无回归**：特别是 `/api/render` 现有请求/响应字段保持兼容（允许增加可选字段，但不移除/改名）。
- **安全优先**：任何“可配置外部 URL”的能力默认不打开开放代理/SSRF 风险。

## 2. 问题清单（按优先级）

### P0
- **P0-01：自定义渲染服务器设置不生效**
  - 现象：`SettingsModal`/`useSettings` 可配置 `renderServerUrl/useCustomServer`，但渲染链路未使用。
  - 影响：用户误以为已切换到自建 Kroki，实际仍走默认 `KROKI_BASE_URL`。

### P1
- **P1-01：format 状态与渲染链路不一致**
  - 现象：状态层支持 `format ∈ {svg,png,pdf}`，但页面强制固定为 `svg`，同时渲染 hook 也被强制传入 `svg`。
  - 影响：状态/分享链接/本地存储存在“看似可配置、实际不可配置”的分支，增加维护成本。

### P2（可延后）
- **P2-01：AI 助手/版本历史模块未接入主流程**
  - 现象：`useAIAssistant`、`useVersionHistory` 和对应面板组件存在，但 `app/page.tsx` 未集成。
  - 影响：功能不可达或不可用（AI 还可能受 CORS/密钥安全约束）。

## 3. 分阶段修复计划

### Phase 1（P0）：打通“自定义渲染服务器”闭环
- **目标**：当用户在设置里启用自定义 Kroki 地址后，远程渲染与下载请求实际使用该地址。
- **实现策略**：
  - 客户端：在调用 `/api/render` 时，追加一个 *可选字段*（例如 `krokiBaseUrl`），仅当用户启用且非空时携带。
  - 服务端：`/api/render` 读取可选字段并进行校验；默认仍使用 `process.env.KROKI_BASE_URL`。
  - 安全：默认不允许任意 URL 导致开放代理；通过环境变量开关/允许名单控制是否接受客户端传入的 baseUrl。
- **验收标准**：
  - 开启自定义服务器后，渲染请求命中自定义 Kroki（可通过服务端错误 payload 中的 `krokiUrl` 或网络请求验证）。
  - 未开启/未配置时行为与现在一致。
  - 非法 URL 返回 400 且错误结构稳定。
- **回滚**：移除客户端可选字段与服务端解析分支，仍使用环境变量。

### Phase 2（P1）：统一 format 策略
- **目标**：消除“状态有 format，但渲染链路强制 svg”的不一致。
- **候选方案**（二选一，建议按你偏好确定后实施）：
  - **方案 A（保持现状，收敛到 SVG）**：删除/忽略 format 的可配置入口（状态不再对外暴露 format 变化），明确产品只渲染 SVG。
  - **方案 B（完整支持 png/pdf）**：取消强制 svg，在 UI 提供 format 选择，并补齐预览/下载/导出操作在非 svg 下的行为。
- **验收标准**：
  - 代码中不存在“format 不生效”的逻辑分叉。
  - 分享链接/本地存储的 format 行为与 UI 一致。

### Phase 3（P2，可选）：模块可达性与安全
- **目标**：让版本历史与 AI 助手成为“可用且可维护”的一等功能，或明确暂不提供。
- **方向**：
  - 版本历史：接入 `app/page.tsx`，与当前图表 ID 绑定，并提供恢复/快照入口。
  - AI 助手：优先改为服务端代理调用（避免浏览器直连 CORS/泄露密钥），或在文档中明确仅本地自用。

## 4. 执行顺序（落地清单）
- [ ] Phase 1：自定义渲染服务器闭环（前后端）
- [ ] Phase 2：format 策略收敛或完整支持（确定方案后实施）
- [ ] Phase 3：版本历史/AI（可选）
- [ ] 验收：`npm run test:smoke` + 手工验证（分享链接、缓存、导出）

